공유 자원 : 여러 프로세스가 공동으로 사용하는 변수, 메모리, 파일 등을 일컬음. 이를 위해 프로세스들의 자원 접근 순서를 정해야함
정하지 않으면 race condition이 발생

임계구역 : 공유 자원 접근 순서에 따라 실행 결과가 달라지는 프로그램 영역. 이 영역에서는 동시 작업이 불가능하고 한 프로세스의 작업이 끝날 때까지 임계구역 밖에서 기다려야함.

임계구역은 producer-consumer problem이 발생한다. 데이터를 버퍼에 넣는 producer와 데이터를 사용하는 consumer가 존재하는데 버퍼를 사용하기 위해서 sum이라는 전역변수로 데이터의 수를 저장한다. 이 때 둘이 동시에 변수 sum에 접근하게 되면 문제가 발생하게 되는데, 이를 해결하기 위해서 상호 배제, 한정 대기, 진행의 융통성의 조건을 만족해야 한다.

임계구역의 문제를 해결하는 가장 단순한 방법은 lock을 사용하는 것이다. 사용이 끝나면 잠금 해제와 동시에 동기화 신호를 보내서 다른 프로세스가 사용할 수 있도록 하는 것이다.

공유 변수 boolean lock = false로 설정되어 있고, false는 잠금이 해제되었음을 뜻한다. lock = true이면 잠겨있다는 뜻으로 무한 루프를 돌면서 기다리게 된다.

    여기서 두 프로세스가 동시에 임계구역에 진입하거나 한 프로세스가 lock = true로 바꾸기도 전에 다른 프로세스가 임계구역에 진입하게 되어 결국 두 프로세스가 임계구역에 들어와서 임계구역에서 충돌이 벌어지게 된다. 이를 예방하기 위해 상호 배제 조건을 지켜야한다.

    이를 위해, 공유 변수를 두 개로 늘려 lock1, lock2를 두게 된다. 일단 잠그고 시작하여 두 프로세스가 서로를 견제할 수 있도록 하게하여 상호 배제 조건을 보장할 수 있다. 그러나 이렇게 되면 두 프로세스가 모두 임계구역에 진입하지 못하는 무한 대기 현상이 발생할 수 있다. 두 프로세스가 서로의 lock = ture를 하고 문맥 교환이 일어나게 되면 무한 대기에 빠져 임계구역에 진입하지 못하는 상태가 된다. 또한 확장성의 한계도 가지고 있다.

    이를 해결하기 위해, int lock = 1로 바꾸어 해결할 수 있다. lock자체를 프로세스 번호로 만들어서 자신의 번호로 lock이 바뀌었을 때에만 임계구역에 진입하도록 허용하는 것이다. 그러나 서로의 프로세스가 진행을 방해하는 방식인 lockstep synchornization 문제가 발생한다. 즉, 진행의 융통성을 보장하지 못한다.

    하드웨어적으로 임계구역 문제를 해결하는 방안이 있는데 while();문과 lock = true;문 중간의 타임아웃에 의한 문제 발생을 원천 차단하도록 while(testandset(&lock == true)); 문을 사용하여 두 명령어를 동시에 실행하면 해결 가능하다. 

    피터슨 알고리즘 : lock외에 turn이라는 변수를 하나 더 두어서 두 프로세스가 동시에 lock을 설정해도 turn 변수를 검사하여 한 프로세스가 양보하도록 만드는 것이다. 임계구역 해결을 위한 세 가지 조건을 충족하나 2개의 프로세스에서만 사용가능하다.

    데커 알고리즘 : lock1, 2를 두고 turn이라는 공용 변수를 하나 더 두어서 차례를 지정하도록 한다. 서로 무한루프에 동시에 진입 시에 공유 변수 turn을 다시 확인하여 자신의 차례가 아니라면 lock을 풀고 차례가 올 때까지 대기한다. 차례가 바뀌면 자신의 lock을 true로 바꾸고 임계구역에 접근한다.

    두 알고리즘 모두 임계구역 해결을 위한 세 가지 조건을 만족하지만 확장성이 낮다.

semaphore : 임계구역 진입 전에 스위치를 두어서 접근을 허가한다. 직접적인 점검이나 바쁜 대기, 동기화 메시지가 필요없다. 임계구역을 들어가기 전에 P()를 통해 진입을 알리고, 임계구역 작업이 종료되면 V()를 통해 임계구역이 비었음을 알린다.

    Semaphore(n)으로 전역변수 RS(사용가능한 자원)를 n으로 초기화한다. 

    P() : 잠금을 수행. RS가 0보다 크면 1 감소, 0보다 작거나 같으면 0보다 커질 때까지 기다린다.

    V() : 잠금 해제와 동시에 동기화를 진행. RS를 1 증가시키고 wake_up()을 통해 임계구역이 사용 가능함을 알림

세마포어를 잘못 사용하면 임계구역이 보호받지 못한다. P()와 V()의 순서가 바뀌거나, P()를 중복사용하거나, 아예 세마포어를 사용하지 않는다면 임계구역을 보호할 수 없다.

만약 모든 프로세스가 세마포어를 사용한다면 굳이 P()와 V()를 사용할 필요가 없다. 

모니터 : 모든 프로세스가 세마포어를 사용한다면, system call처럼 공유자원을 내부에 숨기고 공유자원 접근을 위한 인터페이스만 제공한다.
추가로, 임계구역 보호과 동기화를 위해 wait()와 signal()이라는 상태 변수를 사용한다.

