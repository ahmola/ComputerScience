HTTP 통신은 TCP/IP를 통해 이루어진다.

TCP(전송 계층)는 에플리케이션 계층에서 받은 데이터를 잘게 쪼게 세그먼트로 나누고 관련 정보들을 헤더에 붙여서 네트워크 계층에 넘긴다. 네트워크 계층에서는 헤더에 IP주소외 여러 정보를 추가하여 패킷을 만들고 데이터 링크 계층으로 넘겨서 데이터 링크 계층에서 물리적 신호로 변환하여 데이터를 전송하게 된다. 

컴퓨터는 항상 여러 개의 TCP커넥션을 가지고 있으며 포트 번호를 통해서 유지한다. 

Connection 헤더 : 클라이언트와 서버 간 연결을 어떻게 처리할지 지정하는 HTTP헤더이다. 현재 맺고 있는 커넥션에만 적용될 옵션을 지정해야 할 때 사용된다. 쉼표로 구분하며 다른 커넥션에는 전달되지 않는다. 커넥션을 관리하지 못하면 TCP성능이 안좋아진다.

hop-by-hop(hop는 프록시같은 중개자 등) 헤더명을 기술하는데 헤더 보호하기하기 라고 불린다. 다음 hop으로 전달하기 전에 connection 헤더와 connection 헤더에 기술된 모든 헤더를 삭제한다.

HTTP 커넥션의 종류

    병렬 커넥션 : 여러 개의 TCP 커넥션으로 동시에 HTTP 요청. 각 커넥션의 지연시간이 겹쳐 총 지연 시간을 줄일 수 있다. 항상 빠르지는 않다. 

    지속 커넥션 : 지연 제거를 위한 TCP커넥션 재활용. 계속 연결된 상태로 TCP 커넥션을 끊지 않고 유지한다. 준비작업 시간을 절약할 수 있고 TCP slow start로 인한 지연을 피할 수 있다. 너무 많으면 불필요한 소모가 발생하므로 최대한 적은 수를 유지한다. keep-allive(HTTP/1.0+) 커넥션과 지속 커넥션(HTTP/1.1)이 존재한다.
        keep-alive : 요청 헤더에 Connection:Keep-Alive를 포함시킨다. 헤더에 keep-alive가 없다면 지원하지 않아서 응답 메시지가 전송되고 나면 서버 커넥션이 끊긴다. 커넥션 유지만을 위한 요청이므로 클라이언트나 서버가 해당 요청을 받았다고해서 무조건 따를 필요는 없다. HTTP/1.0에서는 기본 사항이 아니므로 사용하려면 헤더에 포함시켜야한다. body의 길이를 알아야 커넥션을 유지할 수 있으므로 정확한 content-length와 multipart media type 또는 chunked transfer encoding으로 인코드되어야 한다. 

        프록시와 게이트웨이는 메시지 전송 또는 캐시에 전달 시 connection 헤더에 명시된 모든 헤더 필드와 connection 헤더를 제거해야 한다. 그렇지 않으면 프록시는 connection 헤더를 이해하지 못해서 제거하지 않고 그대로 전달한다. 이렇게 되면 서버는 keep-alive헤더로 인해 프록시와 계속해서 커넥션을 유지하게 되는데 정작 프록시는 이해하지 못한다. 응답 메시지를 클라이언트에 전달해서 클라이언트는 keep-alive에 서버가 동의했다고 판단한다. 그런데 프록시는 keep-alive를 이해하지 못하므로 커넥션이 끊기기를 기다리지만 서버는 유지한다고 판단한다. 이 상태에서 클라이언트가 요청을 프록시에 전달하면 프록시가 무시하게 되고 아무런 응답을 받을 수 없게된다.

        그렇기 때문에 프록시는 connection헤더를 전달해서는 안된다. 이를 해결하기 위해서 proxy-connection이라는 헤더와 이를 이해할 수 있는 영리한 프록시를 사용한다. proxy-coonnection 헤더는 전달되더라도 서버가 무시한다. 영리한 프록시가 proxy-connection을 받게되면 connection으로 바꿔 서버에 전달하여 keep-alive를 가능하게 할 수 있다. 그러나 이는 멍청한 프록시가 영리한 프록시 뒤에 위치하면 문제가 다시 발생하게 된다. 영리한 프록시가 connection 헤더로 바꾸게 되고 이를 멍청한 프록시에 전달하면 서버는 멍청한 프록시와 keep-alive 상태가 되어버린다.

        지속 커넥션 : HTTP/1.1에서는 keep-alive를 지원하지 않고 개선된 지속 커넥션을 지원한다. HTTP/1.1에서의 기본 설정 사항이며, 모든 커넥션을 지속 커넥션으로 취급한다. 끊고자 한다면 connection:close를 명시해야 한다. 없으면 계속 유지하지만 영원히 유지하지는 않는다. 헤더에 content-length나 chunked transfer encoding으로 인코드되어있어야 한다. 적어도 2개 이상의 지속 커넥션은 유지해야 한다.

    파이프라인 커넥션 : 공유 TCP 커넥션으로 병령 HTTP 요청. HTTP/1.1의 지속 커넥션을 사용하여 요청을 파이프라이닝한다. 여러 개의 요청이 응답 메시지 도착 전까지 큐에 쌓이게 된다. 지속 커넥션인 경우에만 행해지며, 응답 순서는 요청 순서와 같아야한다. POST와 같이 반복해서 요청할 경우 문제가 생기는 요청은 파이프라인을 통해서 보내면 안된다. 에러가 발생하면 알 수 없기 때문에 비멱등성 요청은 보내지 않는다.

    다중 커넥션 : 요청과 응답 중재